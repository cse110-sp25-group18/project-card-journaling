name: Monitor PR Workflows

on:
  workflow_run:
    types: [completed]

jobs:
  notify-on-error:
    if: ${{ github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    steps:
      - name: 留言提醒：检测到工作流执行失败
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 获取本次 workflow_run 对象
            const run = github.event.workflow_run;
            // workflow_run 里会有一个 pull_requests 数组，表示当前这次运行关联到哪些 PR
            // 通常只会关联到一个 PR，我们遍历整个数组以防万一
            for (const pr of run.pull_requests) {
              const prNumber = pr.number;
              // 留言内容，你可以根据需要改成更详细的提示
              const body = `🚨 检测到 PR #${prNumber} 上的工作流“${run.name}”运行失败。\n
请点击 [Actions 标签](${run.html_url}) 查看详细日志并修复错误。`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }
